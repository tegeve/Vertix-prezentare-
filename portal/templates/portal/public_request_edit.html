{% extends "website/base.html" %}
{% load i18n %}

{% block content %}
<div class="container py-4" style="max-width: 900px;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-1">Edit cerere publică</h1>
      <div class="text-muted small">ID: P-{{ req.id }} • Creat: {{ req.created_at|date:"Y-m-d H:i" }}</div>
    </div>
    <a class="btn btn-outline-secondary" href="{% url 'portal_dashboard' %}">Înapoi</a>
  </div>

  <!-- MAIN CARD -->
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="publicRequestForm">
        {% csrf_token %}

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" value="{{ req.email }}" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Telefon</label>
            <input type="text" class="form-control" name="phone" value="{{ req.phone|default:'' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">Companie</label>
            <input type="text" class="form-control" name="company" value="{{ req.company|default:'' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">CIF</label>
            <input type="text" class="form-control" name="company_cif" value="{{ req.company_cif|default:'' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">Status</label>
            <select class="form-select" name="status_id">
              <option value="">— Neprocesat —</option>
              {% for s in statuses %}
                <option value="{{ s.id }}" {% if req.status_id == s.id %}selected{% endif %}>
                  {{ s.name }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">Dacă nu alegi nimic, rămâne “Neprocesat”.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Tehnician alocat</label>
            <select class="form-select" name="assigned_to_id">
              <option value="">— Nealocat —</option>
              {% for tech in technicians %}
                <option value="{{ tech.id }}" {% if req.assigned_to_id == tech.id %}selected{% endif %}>
                  {{ tech.name }}{% if tech.company_name %} ({{ tech.company_name }}){% endif %}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">Poți lăsa gol dacă nu este alocată.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Descriere</label>
            <textarea class="form-control" name="description" rows="7">{{ req.description }}</textarea>
          </div>

          <!-- Upload documents (Drag & Drop) -->
          <div class="col-12">
            <label class="form-label">Documente</label>

            <div id="dropzone_public_{{ req.id }}" class="border rounded p-3 bg-light" style="cursor:pointer;">
              <div class="fw-semibold">Trage fișiere aici (drag & drop)</div>
              <div class="text-muted small">sau click pentru a selecta. (PDF, imagini, DOC/DOCX, XLS/XLSX, TXT)</div>
              <div id="fileList_public_{{ req.id }}" class="small mt-2"></div>
            </div>

            <input id="fileInput_public_{{ req.id }}" class="form-control d-none" type="file" name="attachments" multiple>
            <div class="form-text mt-2">Max 25MB/fișier (conform validării din view).</div>
          </div>
        </div>

        <hr class="my-4">

        <h2 class="h6 mb-3">Documente atașate</h2>

        {% if req.attachments.exists %}
          <div class="row g-3">
            {% for a in req.attachments.all %}
              {% with a.file.name|lower as fname %}
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">

                      <div class="flex-shrink-0">
                        {% if ".jpg" in fname or ".jpeg" in fname or ".png" in fname or ".webp" in fname or ".gif" in fname %}
                          <a href="{{ a.file.url }}" target="_blank" title="Deschide">
                            <img src="{{ a.file.url }}"
                                 alt="preview"
                                 class="rounded border"
                                 style="width:80px;height:80px;object-fit:cover;">
                          </a>
                        {% elif ".pdf" in fname %}
                          <div class="rounded border d-flex align-items-center justify-content-center"
                               style="width:80px;height:80px;">
                            <span class="fw-bold text-danger">PDF</span>
                          </div>
                        {% elif ".doc" in fname or ".docx" in fname %}
                          <div class="rounded border d-flex align-items-center justify-content-center"
                               style="width:80px;height:80px;">
                            <span class="fw-bold text-primary">DOC</span>
                          </div>
                        {% elif ".xls" in fname or ".xlsx" in fname %}
                          <div class="rounded border d-flex align-items-center justify-content-center"
                               style="width:80px;height:80px;">
                            <span class="fw-bold text-success">XLS</span>
                          </div>
                        {% else %}
                          <div class="rounded border d-flex align-items-center justify-content-center"
                               style="width:80px;height:80px;">
                            <span class="fw-bold">FILE</span>
                          </div>
                        {% endif %}
                      </div>

                      <div class="flex-grow-1" style="min-width:0;">
                        <a href="{{ a.file.url }}" target="_blank"
                           class="fw-semibold text-decoration-none d-block text-truncate">
                          {{ a.file.name|cut:"requests/" }}
                        </a>
                        <div class="small text-muted">
                          Încărcat: {{ a.uploaded_at|date:"Y-m-d H:i" }}
                        </div>
                      </div>

                      <div class="ms-auto">
                        <button class="btn btn-outline-danger btn-sm" type="submit"
                                formmethod="post"
                                formaction="{% url 'public_request_attachment_delete' a.id %}"
                                onclick="return confirm('Ștergi acest document?');">
                          ✕
                        </button>
                      </div>

                    </div>
                  </div>
                </div>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-3">Nu există documente atașate.</p>
        {% endif %}

        <div class="d-flex gap-2 mt-4">
          <button class="btn btn-primary" type="submit">Salvează</button>

          <button class="btn btn-outline-danger ms-auto" type="submit"
                  formmethod="post"
                  formaction="{% url 'public_request_delete' req.id %}"
                  onclick="return confirm('Sigur ștergi cererea publică?');">
            Șterge
          </button>
        </div>

      </form>
    </div>

    <div class="card-footer bg-white border-top-0">
      {% include "portal/_comments_block.html" %}
    </div>

  </div>
</div>

<script>
(function(){
  // ---------- Upload drag & drop pentru PublicRequest (ID-uri unice) ----------
  const dz = document.getElementById("dropzone_public_{{ req.id }}");
  const input = document.getElementById("fileInput_public_{{ req.id }}");
  const list = document.getElementById("fileList_public_{{ req.id }}");
  if(!dz || !input || !list) return;

  function renderFiles(files){
    if(!files || !files.length){
      list.innerHTML = "";
      return;
    }
    const lines = Array.from(files).map(f => `• ${f.name} (${Math.ceil(f.size/1024)} KB)`);
    list.innerHTML = lines.join("<br>");
  }

  dz.addEventListener("click", () => input.click());
  input.addEventListener("change", () => renderFiles(input.files));

  dz.addEventListener("dragover", (e) => {
    e.preventDefault();
    dz.classList.add("border-primary");
  });

  dz.addEventListener("dragleave", () => dz.classList.remove("border-primary"));

  dz.addEventListener("drop", (e) => {
    e.preventDefault();
    dz.classList.remove("border-primary");

    const dt = new DataTransfer();
    Array.from(input.files || []).forEach(f => dt.items.add(f));
    Array.from(e.dataTransfer.files || []).forEach(f => dt.items.add(f));

    input.files = dt.files;
    renderFiles(input.files);
  });
})();
</script>

{% endblock %}
