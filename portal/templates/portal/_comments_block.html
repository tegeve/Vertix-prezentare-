{# portal/_comments_block.html #}

<div class="mt-3">
  <div class="card">
    <div class="card-body">

      <form method="post"
            action="{% url 'chat_post' chat_kind chat_object_id %}"
            enctype="multipart/form-data"
            id="chatForm">
        {% csrf_token %}

        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        <input type="hidden" name="reply_to" id="replyToInput" value="">

        {% if chat_is_staff %}
          <div class="mb-2">
            <label class="form-label small mb-1">Vizibilitate</label>
            <select class="form-select form-select-sm" name="visibility" style="max-width:260px;">
              <option value="PUBLIC">Public (client + staff)</option>
              <option value="INTERNAL">Intern (doar staff)</option>
            </select>
          </div>
        {% else %}
          <input type="hidden" name="visibility" value="PUBLIC">
        {% endif %}

        <!-- Reply banner -->
        <div class="mb-2" id="replyBanner" style="display:none;">
          <div class="alert alert-secondary py-2 px-3 d-flex justify-content-between align-items-center mb-2">
            <div class="small">
              RÄƒspunzi la mesajul <span class="fw-semibold" id="replyBannerId"></span>
              <span class="text-muted" id="replyBannerPreview"></span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelReplyBtn">AnuleazÄƒ</button>
          </div>
        </div>

        <!-- Body + mentions autocomplete -->
        <div class="mb-2 position-relative">
          <textarea id="chatBody"
                    class="form-control"
                    name="body"
                    rows="3"
                    placeholder="Scrie un mesaj... FoloseÈ™te @ pentru a menÈ›iona un utilizator."></textarea>

          <div id="mentionBox"
               class="list-group position-absolute shadow-sm"
               style="z-index:1000; display:none; max-height:220px; overflow:auto; left:0; right:0; top:100%; margin-top:.25rem;">
          </div>
        </div>

        <!-- âœ… Dropzone + input real -->
        <div class="mb-2">
          <label class="form-label small mb-1">AtaÈ™amente</label>

          <div id="chatDropzone"
               class="border rounded p-3 bg-light"
               style="cursor:pointer;">
            <div class="fw-semibold">Trage fiÈ™iere aici (drag & drop)</div>
            <div class="text-muted small">sau click pentru a selecta. PoÈ›i adÄƒuga mai multe fiÈ™iere.</div>
            <div id="chatFileList" class="small mt-2"></div>
          </div>

          <input id="chatFileInput" class="form-control d-none" type="file" name="attachments" multiple>
        </div>

        <button class="btn btn-primary" type="submit">Trimite</button>
      </form>

    </div>
  </div>

  <!-- Mesaje -->
  <div class="mt-3">
    <h6 class="mb-2">DiscuÈ›ii</h6>

    {% if chat_messages %}
      <div class="list-group">
        {% for m in chat_messages %}
          <div class="list-group-item" id="msg-{{ m.id }}">
            <div class="d-flex justify-content-between align-items-start gap-2">

              <div style="min-width:0;">
                <div class="fw-semibold">
                  {{ m.author }}
                  <span class="text-muted small">â€¢ {{ m.created_at|date:"Y-m-d H:i" }}</span>
                  {% if chat_is_staff and m.visibility == "INTERNAL" %}
                    <span class="badge text-bg-dark ms-2">INTERN</span>
                  {% endif %}
                </div>

                {% if m.reply_to %}
                  <div class="small text-muted mb-1">
                    Reply la:
                    <a href="#msg-{{ m.reply_to.id }}" class="text-decoration-none">#{{ m.reply_to.id }}</a>
                    â€” {{ m.reply_to.body|truncatechars:80 }}
                  </div>
                {% endif %}

                <div class="mt-1">{{ m.body|linebreaksbr }}</div>

                {% if m.attachments.all %}
                  <div class="mt-2 d-flex flex-wrap gap-2">
                    {% for a in m.attachments.all %}
                      <a class="btn btn-outline-secondary btn-sm"
                         href="{{ a.file.url }}"
                         target="_blank" rel="noopener">
                        ðŸ“Ž {{ a.original_name|default:"fiÈ™ier" }}
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <button type="button"
                      class="btn btn-outline-primary btn-sm flex-shrink-0"
                      data-reply-id="{{ m.id }}"
                      data-reply-preview="{{ m.body|truncatechars:90|escape }}">
                Reply
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">Nu existÄƒ mesaje.</div>
    {% endif %}
  </div>
</div>

<script>
(function(){
  // =========================
  // Reply logic
  // =========================
  const form = document.getElementById("chatForm");
  const textarea = document.getElementById("chatBody");

  const replyToInput = document.getElementById("replyToInput");
  const replyBanner = document.getElementById("replyBanner");
  const replyBannerId = document.getElementById("replyBannerId");
  const replyBannerPreview = document.getElementById("replyBannerPreview");
  const cancelReplyBtn = document.getElementById("cancelReplyBtn");

  function setReply(id, preview){
    if(replyToInput) replyToInput.value = id;
    if(replyBanner) replyBanner.style.display = "block";
    if(replyBannerId) replyBannerId.textContent = "#" + id;
    if(replyBannerPreview) replyBannerPreview.textContent = preview ? (" â€” " + preview) : "";
    if(form) form.scrollIntoView({behavior:"smooth", block:"center"});
    if(textarea) textarea.focus();
  }

  function clearReply(){
    if(replyToInput) replyToInput.value = "";
    if(replyBanner) replyBanner.style.display = "none";
    if(replyBannerId) replyBannerId.textContent = "";
    if(replyBannerPreview) replyBannerPreview.textContent = "";
  }

  document.querySelectorAll("[data-reply-id]").forEach(btn => {
    btn.addEventListener("click", () => {
      setReply(btn.getAttribute("data-reply-id"), btn.getAttribute("data-reply-preview") || "");
    });
  });

  if(cancelReplyBtn){
    cancelReplyBtn.addEventListener("click", clearReply);
  }

  // =========================
  // Drag & Drop attachments
  // =========================
  const dz = document.getElementById("chatDropzone");
  const input = document.getElementById("chatFileInput");
  const list = document.getElementById("chatFileList");

  function renderFiles(files){
    if(!list) return;
    if(!files || !files.length){
      list.innerHTML = "";
      return;
    }
    const lines = Array.from(files).map(f => `â€¢ ${f.name} (${Math.ceil(f.size/1024)} KB)`);
    list.innerHTML = lines.join("<br>");
  }

  if(dz && input && list){
    dz.addEventListener("click", () => input.click());
    input.addEventListener("change", () => renderFiles(input.files));

    dz.addEventListener("dragover", (e) => {
      e.preventDefault();
      dz.classList.add("border-primary");
    });

    dz.addEventListener("dragleave", () => dz.classList.remove("border-primary"));

    dz.addEventListener("drop", (e) => {
      e.preventDefault();
      dz.classList.remove("border-primary");

      const dt = new DataTransfer();
      Array.from(input.files || []).forEach(f => dt.items.add(f));
      Array.from(e.dataTransfer.files || []).forEach(f => dt.items.add(f));

      input.files = dt.files;
      renderFiles(input.files);
    });
  }

  // =========================
  // Mentions autocomplete (@)  âœ… email-based (no username in your User)
  // Endpoint: /ro/portal/chat/autocomplete/users/?q=...
  // Returns: {"results":[{"id":..,"email":"..","label":".."}]}
  // =========================
  const mentionBox = document.getElementById("mentionBox");
  if(!textarea || !mentionBox) return;

  let lastQuery = "";
  let activeIndex = -1;

  function hideMentions(){
    mentionBox.style.display = "none";
    mentionBox.innerHTML = "";
    activeIndex = -1;
  }

  function getMentionQuery(text, pos){
    const left = text.slice(0, pos);
    // token dupÄƒ @ pÃ¢nÄƒ la spaÈ›iu (fÄƒrÄƒ @ suplimentar)
    const match = left.match(/@([^\s@]{1,80})$/);
    return match ? match[1] : null;
  }

  function setActive(items, idx){
    items.forEach(el => el.classList.remove("active"));
    if(idx >= 0 && idx < items.length){
      items[idx].classList.add("active");
      activeIndex = idx;
    } else {
      activeIndex = -1;
    }
  }

  function insertEmail(email){
    const cursorPos = textarea.selectionStart;
    const before = textarea.value.slice(0, cursorPos).replace(/@([^\s@]*)$/, `@${email} `);
    const after = textarea.value.slice(cursorPos);
    textarea.value = before + after;

    const newPos = before.length;
    textarea.setSelectionRange(newPos, newPos);
    textarea.focus();
    hideMentions();
  }

  async function fetchMentions(q){
    const url = `/ro/portal/chat/autocomplete/users/?q=${encodeURIComponent(q)}`;
    const r = await fetch(url, {headers: {"X-Requested-With": "XMLHttpRequest"}});
    if(!r.ok) return {results: []};
    return await r.json();
  }

  function renderMentions(results){
    mentionBox.innerHTML = "";

    if(!results || !results.length){
      hideMentions();
      return;
    }

    results.forEach((u) => {
      const email = u.email || "";
      if(!email) return;

      const a = document.createElement("a");
      a.href = "#";
      a.className = "list-group-item list-group-item-action py-2";
      a.textContent = u.label || email;
      a.dataset.email = email;

      a.addEventListener("mousedown", (ev) => {
        ev.preventDefault();
        insertEmail(email);
      });

      mentionBox.appendChild(a);
    });

    const items = Array.from(mentionBox.querySelectorAll(".list-group-item"));
    if(!items.length){
      hideMentions();
      return;
    }

    mentionBox.style.display = "block";
    setActive(items, 0);
  }

  textarea.addEventListener("input", async () => {
    const cursorPos = textarea.selectionStart;
    const q = getMentionQuery(textarea.value, cursorPos);

    if(q === null || q.length < 1){
      lastQuery = "";
      hideMentions();
      return;
    }

    if(q === lastQuery) return;
    lastQuery = q;

    try{
      const data = await fetchMentions(q);
      renderMentions(data.results || []);
    } catch(e){
      hideMentions();
    }
  });

  textarea.addEventListener("keydown", (e) => {
    if(mentionBox.style.display === "none") return;

    const items = Array.from(mentionBox.querySelectorAll(".list-group-item"));
    if(!items.length) return;

    if(e.key === "ArrowDown"){
      e.preventDefault();
      setActive(items, (activeIndex + 1) % items.length);
      return;
    }

    if(e.key === "ArrowUp"){
      e.preventDefault();
      setActive(items, (activeIndex - 1 + items.length) % items.length);
      return;
    }

    if(e.key === "Enter"){
      // Enter selecteazÄƒ menÈ›iunea, NU trimite form
      e.preventDefault();
      const chosen = items[activeIndex] || items[0];
      const email = chosen?.dataset?.email;
      if(email) insertEmail(email);
      return;
    }

    if(e.key === "Escape"){
      e.preventDefault();
      hideMentions();
      return;
    }
  });

  document.addEventListener("click", (e) => {
    if(e.target === textarea) return;
    if(mentionBox.contains(e.target)) return;
    hideMentions();
  });

})();
</script>
